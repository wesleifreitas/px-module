function pxDataGridCtrl(e,t,a,r,l,n,i,o,d,s){var c=r.moment;o.currentPage=0,o.reset=function(){o.currentPage=0,o.currentRecordCount=0,o.internalControl.selectedItems=[],o.internalControl.rowsSelected=[],o.rowsSelected=[],angular.isDefined(o.internalControl.checkAll)&&(o.internalControl.checkAll.checked=!1,o.internalControl.checkAll.indeterminate=!1)},o.eventInit=function(){$("#"+o.id+"_pxDataTable").on("page.dt",function(){var e=o.internalControl.table.page.info();if(o.ajaxUrl||""===o.url)o.internalControl.table.context[0].oLanguage.sInfo=e.recordsTotal+" registros carregados.";else{if(!angular.isNumber(o.nextRowFrom))return;e.page===e.pages-1&&(o.currentPage=e.page,o.demand&&o.getData(o.nextRowFrom,o.nextRowTo)),0===e.start&&(e.start=1),o.internalControl.table.context[0].oLanguage.sInfo=e.recordsTotal+" registros carregados. Total de registros na base de dados: "+o.recordCount}}),o.updateDataTableSelectAllCtrl=function(e){if(o.check===!0){var t=e.table().node(),a=$('tbody input[type="checkbox"]',t),r=$('tbody input[type="checkbox"]:checked',t),l=$('thead input[name="select_all"]',t).get(0);o.internalControl.checkAll=l,0===r.length?(l.checked=!1,"indeterminate"in l&&(l.indeterminate=!1)):r.length===a.length?(l.checked=!0,"indeterminate"in l&&(l.indeterminate=!1)):(l.checked=!0,"indeterminate"in l&&(l.indeterminate=!0))}},$("#"+o.id+"_pxDataTable tbody").on("click",'i[class="fa fa-pencil"]',function(e){var t=$(this).closest("tr");o.internalControl.updatedRow=t;var a=o.internalControl.table.row(t).data(),r={};angular.forEach(o.fields,function(e){r[e.field]=a.edit[e.field]});var l={itemClick:a,itemEdit:r};o.itemEdit({event:l}),e.stopPropagation()}),$("#"+o.id+"_pxDataTable tbody").on("click",'input[type="checkbox"]',function(e){var t=$(this).closest("tr"),a=o.internalControl.table.row(t).data(),r=a.pxDataGridRowNumber,l=$.inArray(r,o.rowsSelected);this.checked&&-1===l?(o.rowsSelected.push(r),o.internalControl.selectedItems.push(a)):this.checked||-1===l||(o.rowsSelected.splice(l,1),o.internalControl.selectedItems.splice(l,1)),this.checked?t.addClass("selected"):t.removeClass("selected"),o.updateDataTableSelectAllCtrl(o.internalControl.table),e.stopPropagation()}),$("#"+o.id+"_pxDataTable tbody").on("click","td div i",function(e){var t=$(this).closest("td"),a=t.index(),r=o.internalControl.table.column.index("fromVisible",a),l=angular.copy(o.internalControl.table.row(t).data());if(o.links[r]){l.link=o.links[r],l.linkId=o.links[r].linkId;var n={itemClick:l};o.itemClick({event:n}),e.stopPropagation()}}),$("#"+o.id+"_pxDataTable").on("click","tbody td, thead th:first-child",function(e){var t=$(this).closest("tr"),a=angular.copy(o.internalControl.table.row(t).data());a.pxLink={link:!1};var r={itemClick:a};o.itemClick({event:r}),"I"!==e.target.tagName&&$(this).parent().find('input[type="checkbox"]').trigger("click")}),$("#"+o.id+'_pxDataTable thead input[name="select_all"]').on("click",function(e){this.checked?$("#"+o.id+'_pxDataTable tbody input[type="checkbox"]:not(:checked)').trigger("click"):$("#"+o.id+'_pxDataTable tbody input[type="checkbox"]:checked').trigger("click"),e.stopPropagation()}),$("#"+o.id+"_pxDataTable").on("draw",function(){o.updateDataTableSelectAllCtrl(o.internalControl.table)})},o.getData=function(a,r){if(!o.internalControl.working){o.internalControl.working=!0;var l=o.fields,n=!0;if(angular.forEach(l,function(e){if(e.filterObject={},angular.isDefined(e.filter)){var a="#"+e.filter,r=e.filter;e.filterGroup?(a+="_groupSearch_inputSearch",r="selectedItem"):angular.isDefined(angular.element($(a+"_inputSearch").get(0)).scope())&&(a+="_inputSearch",r="selectedItem");var l=angular.element($(a).get(0)),i=l.data("$ngModelController");if(angular.isDefined(i)&&(i.$validate(),i.$valid?l.trigger("keyup"):(l.trigger("keyup"),n=!1)),angular.isDefined(angular.element($(a).get(0)).scope())&&angular.element($(a).get(0)).scope().hasOwnProperty(r)){var o=angular.element($(a).get(0)).scope()[r],d=e.field,s=o;angular.isDefined(e.filterOptions)&&e.filterOptions.hasOwnProperty("selectedItem")&&(d=e.filterOptions.field,o?(s=o[e.filterOptions.selectedItem],angular.isDefined(s)||(s=o[e.filterOptions.selectedItem.toUpperCase()]),"%"===s&&(s=null)):s=null),null!==s&&""!==s?e.filterObject={field:d,value:s}:e.filterObject={}}else e.filterObject={};if(e.filterObject.value=t.filterOperator(e.filterObject.value,e.filterOperator),"BETWEEN"===String(e.filterOperator).toUpperCase()){var u="#"+e.filterOptions.endField,p=e.filterOptions.endField;angular.isDefined(angular.element($(u+"_inputSearch").get(0)).scope())&&(u+="_inputSearch",p="selectedItem"),l=angular.element($(u).get(0)),i=l.data("$ngModelController"),angular.isDefined(i)&&(i.$validate(),i.$valid?l.trigger("keyup"):(l.trigger("keyup"),n=!1));var f=angular.element($(u).get(0)).scope()[p],g=e.filterOptions.endField,m=f;if(angular.isDefined(angular.element($(u).get(0)).scope())&&angular.element($(u).get(0)).scope().hasOwnProperty(p)){if(angular.isDefined(e.filterOptions)&&e.filterOptions.hasOwnProperty("selectedItem")&&(g=e.filterOptions.field,f?(m=f[e.filterOptions.selectedItem],angular.isDefined(m)||(m=f[e.filterOptions.selectedItem.toUpperCase()]),"%"===m&&(m=null)):m=null),e.filterObject.endField=g,angular.isDefined(m)&&null!==m&&""!==m?e.filterObject.endValue=m:(e.filterObject.endValue=e.filterObject.value,angular.element($(u).get(0)).scope()[g]=e.filterObject.value),e.filterObject.value>e.filterObject.endValue){var b=angular.copy(e.filterObject.endValue);e.filterObject.endValue=e.filterObject.value,angular.element($(u).get(0)).scope()[g]=e.filterObject.value,e.filterObject.value=b,angular.element($(a).get(0)).scope()[e.filter]=b}}else e.filterObject.endValue=e.filterObject.value,angular.element($(u).get(0)).scope()[g]=e.filterObject.value;("NUMERIC"===e.type.toUpperCase()||"INT"===e.type.toUpperCase())&&(e.filterObject.value=c(e.filterObject.value).format("YYYYMMDD"),e.filterObject.endValue=c(e.filterObject.endValue).format("YYYYMMDD"))}}}),!n)return o.reset(),$("#"+o.id+"_pxDataTable").DataTable().clear().draw(),void(o.internalControl.working=!1);var d={};d.url=o.url,d.method=o.method,d.schema=o.schema,angular.isDefined(o.view)&&""!==o.view?d.table=o.view:d.table=o.table,d.fields=angular.toJson(l),d.orderBy=angular.toJson(o.orderBy),d.rows=o.rowsProcess,angular.isDefined(a)&&(d.rowFrom=a),angular.isDefined(r)&&(d.rowTo=r),d.group=o.group,d.groupItem=o.groupItem,d.groupLabel=o.groupLabel,o.where&&(o.where=t.setFilterObject(o.where,!1,e.GROUP_TABLE),d.where=angular.toJson(o.where)),0===a&&(o.reset(),$("#"+o.id+"_pxDataTable").DataTable().clear().draw()),i.select(d,function(e){if(o.debug&&console.info("px-data-grid "+o.id+" getData",e),angular.isDefined(e.data.fault))o.internalControl.working=!1,alert("Ops! Ocorreu um erro inesperado.\nPor favor contate o administrador do sistema!");else if(e.data.query.length>0){angular.forEach(e.data.query,function(e){o.addDataRow(e)}),o.recordCount=e.data.recordCount,o.nextRowFrom=e.data.rowFrom+o.rowsProcess,o.nextRowTo=e.data.rowTo+o.rowsProcess;o.internalControl.table;$("#"+o.id+"_pxDataTable").DataTable().page(o.currentPage).draw(!1);var t=$("#"+o.id+"_pxDataTable").DataTable().page.info();0===t.start&&(t.start=1);var a=t.recordsTotal+" registros carregados.";angular.isNumber(o.recordCount)&&(a+=" Total de registros na base de dados: "+o.recordCount),$("#"+o.id+"_pxDataTable_info").html(a),o.demand?o.internalControl.working=!1:o.getData(o.nextRowFrom,o.nextRowTo)}else o.internalControl.working=!1})}},o.updateDataRow=function(e){var t=o.internalControl.table.row(o.internalControl.updatedRow).data();angular.forEach(o.fields,function(a){angular.isDefined(t[a.field])&&angular.isDefined(e[a.field])&&(t.edit[a.field]=e[a.field],angular.isDefined(a.stringMask)?angular.isDefined(a.pad)?t[a.field]=l.maskFormat(n.pad(a.pad,e[a.field],!0),a.stringMask).result:t[a.field]=l.maskFormat(e[a.field],a.stringMask).result:t[a.field]=e[a.field])}),o.internalControl.table.row(o.internalControl.updatedRow).data(t).draw()},o.sortDataBy=function(e){$("#"+o.id+"_pxDataTable").DataTable().order(e).draw()},o.addDataRow=function(e){o.currentRecordCount++;var t={};t.value={},t.pxDataGridRowNumber=o.currentRecordCount,t.edit={},angular.forEach(o.fields,function(a){if(a.link&&(t[a.linkId]=a),"undefined"!=typeof a.field){if(angular.isDefined(e[a.field])?t[a.field]=e[a.field]:t[a.field]=e[a.field.toUpperCase()],t.value[a.field]=angular.copy(t[a.field]),angular.isDefined(t[a.field])||(t[a.field]=""),t.edit[a.field]=angular.copy(t[a.field]),a.stringMask){var r="";switch(a.stringMask){case"cpf":r="###.###.###-##";break;case"cnpj":r="##.###.###/####-##";break;case"cep":r="#####-###";break;case"brPhone":r=(11===t[a.field].length,"(##) #####-####");break;case"cpfCnpj":"varchar"===a.type||"char"===a.type||"string"===a.type?r=11===String(t[a.field]).length?"###.###.###-##":"##.###.###/####-##":(t[a.field]=String(Number(t[a.field])),r=t[a.field].length>11?"##.###.###/####-##":"###.###.###-##");break;default:r=angular.copy(a.stringMask)}angular.isDefined(a.pad)?t[a.field]=l.maskFormat(n.pad(a.pad,t[a.field],!0),r).result:t[a.field]=l.maskFormat(String(t[a.field]),r).result}if(a.moment){var i=c(Date.parse(t[a.field])).format(a.moment);angular.isDate(t[a.field])||"Invalid date"!==i&&"date"===a.type?t[a.field]=i:parseInt(t[a.field])>0&&parseInt(t[a.field])<=12?t[a.field]=c.months()[parseInt(t[a.field])-1]:8===String(t[a.field]).length?t[a.field]=c(new Date(String(t[a.field]).substr(0,4),String(t[a.field]).substr(4,2)-1,String(t[a.field]).substr(6,2))).format(a.moment):t[a.field]=""}if(a.numeral)switch(a.numeral){case"currency":t[a.field]=numeral(t[a.field]).format("0,0.00");break;default:t[a.field]=numeral(t[a.field]).format(a.numeral)}}if(o.labelFunction&&a.label){o.labelFunction({event:{item:a,data:t}})}}),$("#"+o.id+"_pxDataTable").DataTable().row.add(t).draw()},o.removeRow=function(e,t){".selected"===e?o.internalControl.table.rows(".selected").remove().draw(!1):o.internalControl.table.rows(e).remove().draw()},o.clearData=function(){o.currentRecordCount>0&&$("#"+o.id+"_pxDataTable").DataTable().clear().draw()},o.remove=function(){var e=o.fields,t=JSON.parse(o.config),a=t.table;angular.isDefined(a)||(a=o.table);var r={};r.schema=o.schema,r.table=a,r.fields=angular.toJson(e),r.selectedItems=angular.toJson(o.internalControl.selectedItems),i.remove(r,function(e){if(o.debug&&console.info("pxDataGrid remove: ",e),e.data.success){o.internalControl.table.rows(".selected").remove().draw(!1);var t=o.internalControl.table.page.info();0===t.start&&(t.start=1),o.recordCount-=o.rowsSelected.length,$("#"+o.id+"_pxDataTable_info").html(t.recordsTotal+" registros carregados. Total de registros na base de dados: "+o.recordCount),o.internalControl.selectedItems=[],o.rowsSelected=[]}else alert("Ops! Ocorreu um erro inesperado.\nPor favor contate o administrador do sistema!")})}}function pxDataGridService(e,t,a){function r(r,l){r.dsn=e.PROJECT_DSN,r.cfcPath=e.PX_CFC_PATH,r.method=r.method||"POST",""===r.url&&(r.url="../../../rest/px-project/system/px-data-grid/getData");try{r.user=a.globals.currentUser.usu_id}catch(n){r.user=-1}angular.isDefined(r.orderBy)||(r.orderBy=""),angular.isDefined(r.groupItem)||(r.groupItem=""),angular.isDefined(r.groupLabel)||(r.groupLabel=""),angular.isDefined(r.where)||(r.where=""),t({method:r.method,url:r.url,data:r}).then(function(e){l(e)},function(e){alert("Ops! Ocorreu um erro inesperado.\nPor favor contate o administrador do sistema!")})}function l(r,l){r.dsn=e.PROJECT_DSN,r.cfcPath=e.PX_CFC_PATH,r.user=a.globals.currentUser.usu_id,t({method:"POST",url:"../../../rest/px-project/system/px-data-grid/removeData",data:r}).then(function(e){l(e)},function(e){alert("Ops! Ocorreu um erro inesperado.\nPor favor contate o administrador do sistema!")})}var n={};return n.select=r,n.remove=l,n}angular.module("px-data-grid.filter",[]).filter("dataGridRefresh",[function(){return function(e){return e?"fa fa-refresh fa-spin":"fa fa-refresh"}}]);var module=angular.module("px-data-grid",["px-data-grid.service","px-data-grid.filter","px-array-util","px-date-util","px-mask-util","px-string-util","px-util"]);module.directive("pxDataGrid",["pxConfig","pxArrayUtil","pxUtil","$timeout","$sce","$rootScope",function(e,t,a,r,l,n){return{restrict:"E",replace:!0,transclude:!1,template:'<div class="px-data-grid"><table id="{{id}}_pxDataTable" ng-bind-html="dataTable" class="{{class}}" width="100%"></table></div>',scope:{id:"@id",debug:"=pxDebug",tfoot:"=pxFoot",config:"@pxConfig",lengthChange:"=pxLengthChange",lengthMenu:"=pxLengthMenu",ajaxUrl:"@pxAjaxUrl",schema:"@pxSchema",table:"@pxTable",fields:"@pxFields",orderBy:"@pxOrderBy",group:"@pxGroup",groupItem:"@pxGroupItem",groupLabel:"@pxGroupLabel",where:"@pxWhere",columns:"@pxColumns",check:"=pxCheck",edit:"=pxEdit",init:"&pxInit",configChange:"&pxConfigChange",itemClick:"&pxItemClick",itemEdit:"&pxItemEdit",dataInit:"=pxDataInit",rowsProcess:"@pxRowsProcess",demand:"@pxDemand",control:"=pxControl",labelFunction:"&pxLabelFunction"},link:function(i,o,d){o.on("$destroy",function(){s()}),"px-data-grid"===d["class"].trim()?i["class"]="table dataTable hovered":i["class"]="table dataTable hovered "+d["class"].replace("px-data-grid",""),angular.isDefined(i.id)&&""!==i.id||console.warn("pxDataGrid: Existe um px-data-grid sem id, isto pode causar sérios problemas em seu código!"),i.id=i.id||"pxTable",i.rowsProcess=parseInt(i.rowsProcess)||100,angular.isDefined(i.demand)?i.demand="true"===i.demand:i.demand=!0,angular.isDefined(i.group)?i.group="true"===i.group:i.group=e.GROUP,i.events=!1;var s=i.$watch("config",function(o,d){if(""!==o){if(o=JSON.parse(o),""!==d&&angular.isDefined(i.fields)){var s=$("#"+i.id+"_pxDataTable");s.DataTable().destroy(),i.reset()}if(i.url=o.url||"",i.method=o.method,i.fields=o.fields,i.dataTable="",i.dataTable+="<thead>",i.aoColumns=[],i.columns="",i.foot="",i.schema=o.schema||"dbo",i.table=o.table,i.view=o.view,i.orderBy=o.orderBy,i.where=o.where,i.group=i.group||e.GROUP,angular.isDefined(o.group)&&(i.group=o.group),angular.isDefined(o.groupItem)&&(i.groupItem=o.groupItem),angular.isDefined(o.groupLabel)&&(i.groupLabel=o.groupLabel),i.group===!0){if(""===e.GROUP_ITEM_SUFFIX)i.groupItem=i.groupItem||e.GROUP_ITEM;else if(!angular.isDefined(i.groupItem)){i.groupItem=i.groupItem||i.table+"_"+e.GROUP_ITEM_SUFFIX;for(var c=0;c<e.GROUP_REPLACE.length;c++)i.groupItem=i.groupItem.replace(e.GROUP_REPLACE[c],"")}if(""===e.GROUP_LABEL_SUFFIX)i.groupLabel=i.groupLabel||e.GROUP_LABEL;else if(!angular.isDefined(i.groupLabel)){i.groupLabel=i.groupLabel||e.GROUP_TABLE+"_"+e.GROUP_LABEL_SUFFIX;for(var u=0;u<e.GROUP_REPLACE.length;u++)i.groupLabel=i.groupLabel.replace(e.GROUP_REPLACE[u],"")}}i.group&&-1===t.getIndexByProperty(i.fields,"field",i.groupLabel)&&1===n.globals.currentUser.per_developer&&(""===e.GROUP_ITEM?i.fields.push({title:"Grupo",field:i.groupLabel,type:"string",filter:i.id,filterOperator:"=",filterOptions:{field:i.groupItem,selectedItem:e.GROUP_TABLE+"_"+e.GROUP_ITEM_SUFFIX},filterGroup:!0}):i.fields.push({title:"Grupo",field:i.groupLabel,type:"string",filter:i.id,filterOperator:"=",filterOptions:{field:i.groupItem,selectedItem:e.GROUP_ITEM},filterGroup:!0}));var p=0,f={},g=0;i.columnDefs=[],i.links={},angular.forEach(i.fields,function(e){e.width=e.width||"","center"===e.align?e.align="text-center":"right"===e.align?e.align="text-right":e.align="text-left",0===p&&i.check===!0&&(i.columns+='<th class="text-left" width="1%"><input name="select_all" value="1" type="checkbox"></th>',i.foot+='<th width="1%"></th>',f={},f.mData="pxDataGridRowNumber",i.aoColumns.push(f),i.columnDefs.push({targets:g,searchable:!1,orderable:!1,className:"dt-body-center",render:function(e,t,a,r){return"<input type='checkbox'>"}}),g++),p++,1===p&&i.edit===!0&&(i.columns+='<th class="text-center" width="1%"><i class=""></i></th>',i.foot+='<th width="1%"></th>',f={},f.mData="edit",i.aoColumns.push(f),i.columnDefs.push({targets:g,searchable:!1,orderable:!1,className:"dt-body-center edit",render:function(e,t,a,r){return"<i class='fa fa-pencil'>"}}),g++),e.link||e["class"]?(e.width="1%",i.links[g]=e,i.columnDefs.push({mData:e.linkId,targets:g,searchable:!0,orderable:!1,className:"dt-body-center",render:function(t,a,r,l){return"undefined"==typeof e.icon&&(e.icon=""),e.link?"<div class='link "+e.align+"'><i link='true' linkId="+e.linkId+" class='"+e["class"]+"'>"+e.icon+"</i></div>":"<div class='"+e.align+"'><i class='"+e["class"]+"'>"+e.icon+"</i></div>"}})):e.label&&i.columnDefs.push({mData:e.linkId,targets:g,searchable:!0,orderable:!1,className:"dt-body-center",render:function(t,a,r,l){return"<div class='"+e.align+"'>"+t+"</div>"}}),e.visible===!1&&i.columnDefs.push({targets:g,visible:!1,render:function(e,t,a,r){return e}}),g++,i.columns+='<th class="text-left">'+e.title+"</th>",i.foot+='<th class="text-left"></th>',f={},f.mData=e.field,i.aoColumns.push(f),p++}),i.dataTable+=i.columns,i.dataTable+="</thead>",i.dataTable+="<tbody></tbody>",i.dataTable+='<tfoot class="tfoot">',i.dataTable+=i.foot,i.dataTable+="</tfoot>",i.dataTable=l.trustAsHtml(i.dataTable),r(function(){i.rowsSelected=[];var e="";e+="l",e+="t",e+="i",e+="p",e+="r";var t={};i.ajaxUrl&&(t.ajax={url:i.ajaxUrl,dataSrc:""}),t.language={processing:"Processando...",search:"Filtrar registros carregados",lengthMenu:"Visualizar _MENU_ registros",info:"_TOTAL_ registros carregados.",infoEmpty:"Nenhum registro encontrado",zeroRecords:"Nenhum registro encontrado",emptyTable:"Nenhum registro encontrado.",infoFiltered:"",paginate:{first:"Primeira",previous:"« Anterior",next:"Próxima »",last:"Última"}},a.isMobile()&&(t.pagingType="simple",t.pageLength=8),t.bFilter=!0,t.bLengthChange=i.lengthChange,t.lengthMenu=i.lengthMenu,t.sDom=e,t.bProcessing=!0,t.aoColumns=i.aoColumns,t.destroy=!0,t.columnDefs=i.columnDefs,t.order=[],t.rowCallback=function(e,t,a){var r=t.pxDataGridRowNumber;-1!==$.inArray(r,i.rowsSelected)&&($(e).find('input[type="checkbox"]').prop("checked",!0),$(e).addClass("selected"))},$("#"+i.id+"_pxDataTable").dataTable(t),i.dataInit===!0&&i.getData(0,i.rowsProcess);$("#"+i.id+"_pxDataTable").DataTable();i.internalControl.table=$("#"+i.id+"_pxDataTable").DataTable(),i.events||(i.eventInit(),i.events=!0),i.creationcomplete?i.configChange({event:{config:JSON.parse(i.config)}}):(i.creationcomplete=!0,i.init({event:{config:JSON.parse(i.config)}}))},0)}});i.internalControl=i.control||{},i.internalControl.working=!1,i.internalControl.getData=function(){r(function(){i.getData(0,i.rowsProcess)},0)},i.internalControl.sortDataBy=function(e){i.sortDataBy(e)},i.internalControl.addDataRow=function(e){i.addDataRow(e)},i.internalControl.updateDataRow=function(e){i.updateDataRow(e)},i.internalControl.removeRow=function(e,t){angular.isDefined(t)||(t=!0),i.removeRow(e,t)},i.internalControl.clearData=function(){i.clearData()},i.internalControl.remove=function(){i.remove()},i.internalControl.selectedItems=[],i.currentRecordCount=0},controller:pxDataGridCtrl}}]),pxDataGridCtrl.$inject=["pxConfig","pxUtil","pxArrayUtil","pxDateUtil","pxMaskUtil","pxStringUtil","pxDataGridService","$scope","$http","$timeout"],angular.module("px-data-grid.service",[]).factory("pxDataGridService",pxDataGridService),pxDataGridService.$inject=["pxConfig","$http","$rootScope"];