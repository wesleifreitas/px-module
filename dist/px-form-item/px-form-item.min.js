angular.module("px-form-item",["ngMessages","ui.mask"]).directive("pxEnter",[function(){return function(e,r,n){r.bind("keydown keypress",function(r){13===r.which&&(e.$apply(function(){e.$eval(n.pxEnter)}),r.preventDefault())})}}]).directive("pxMessage",[function(){return{restrict:"E",require:"^form",replace:!0,transclude:!1,template:'<div class="help-block" ng-messages="elementMessage"><p ng-message="required">{{messages.required}}</p><p ng-message="email">{{messages.email}}</p><p ng-message="minlength">{{messages.minlength}}</p><p ng-message="maxlength">{{messages.maxlength}}</p></div>',scope:{elementMessage:"=pxElement",messagesCustom:"=?pxMessages"},link:function(e,r,n,t){e.elementMessage=e.elementMessage.$error,e.messagesCustom=e.messagesCustom||{},e.messages={},e.messages.required=e.messagesCustom.required||"Campo obrigatório.",e.messages.email=e.messagesCustom.email||"E-mail inválido.",e.messages.minlength=e.messagesCustom.minlength||"Muito curto.",e.messages.maxlength=e.messagesCustom.maxlength||"Muito longo."}}}]).directive("pxShowError",["$timeout","$rootScope",function(e,r){return{restrict:"E",require:"^form",replace:!0,transclude:!1,template:'<p class="help-block px-show-error">{{error}}</p>',scope:{element:"@pxElement",confirm:"@pxConfirm",confirmError:"@pxConfirmError",minLengthError:"@pxMinlengthError"},link:function(r,n,t,l){r.elementShowError=angular.element($("#"+r.element).get(0)),r.elementShowError.on("keyup blur",function(e){r.validateElement()}),e(function(){r.validateElement()},0)},controller:["$scope",function(e){e.validateElement=function(){var r="#"+e.element;angular.isDefined(angular.element($(r+"_groupSearch_inputSearch").get(0)).scope())?r+="_groupSearch_inputSearch":angular.isDefined(angular.element($(r+"_inputSearch").get(0)).scope())&&(r+="_inputSearch");var n=e.elementShowError.data("$ngModelController");if(angular.isDefined(n)){var t=angular.element($("#"+e.confirm).get(0)),l=t.data("$ngModelController");e.error="",angular.isDefined(e.confirm)&&(String(l.$modelValue)!==String(n.$modelValue)?n.$setValidity("confirm",!1):n.$setValidity("confirm",!0)),n.$invalid?(e.$apply(function(){n.$error.deps?e.error=e.elementShowError.scope().depsError:n.$error.required||n.$error.requiredsearch?e.error="Campo obrigatório":n.$error.email?e.error="E-mail inválido":n.$error.minlength?e.error=e.minLengthError:n.$error.unique?e.error="Campo já existente":n.$error.confirm?angular.isDefined(e.confirmError)?e.error=e.confirmError:e.error="Campo não confere":console.warn("px-show-error:","$error ausente",n.$error)}),e.elementShowError.css({borderColor:"#A94442"})):(e.$apply(function(){e.error=""}),e.elementShowError.css({borderColor:"#CCCCCC"}))}}}]}}]).directive("pxValidNumber",[function(){return{require:"?ngModel",link:function(e,r,n,t){t&&(t.$parsers.push(function(e){var r=e.replace(/[^0-9]+/g,"");return e!==r&&(t.$setViewValue(r),t.$render()),r}),r.bind("keypress",function(e){32===e.keyCode&&e.preventDefault()}))}}}]).directive("pxCnpjMask",["$compile",function(e){return{priority:100,restrict:"A",scope:{cleanValue:"@cleanValue"},require:"?ngModel",link:function(r,n,t,l){l&&(angular.isDefined(t.uiMask)||(t.$set("uiMask","99.999.999/9999-99"),e(n)(r)),l.$parsers.push(function(e){if(angular.isDefined(e)){var r=String(e).replace(/[^0-9]+/g,"");return e!==r&&l.$setViewValue(r),r}}),r.value2mask=function(e){l.$setViewValue(e)})},controller:["$scope",function(e){e.pxForm2mask=function(r){e.value2mask(r)}}]}}]).directive("pxCpfMask",["$compile",function(e){return{priority:100,restrict:"A",scope:{cleanValue:"@cleanValue"},require:"?ngModel",link:function(r,n,t,l){l&&(angular.isDefined(t.uiMask)||(t.$set("uiMask","999.999.999-99"),e(n)(r)),l.$parsers.push(function(e){if(angular.isDefined(e)){var r=String(e).replace(/[^0-9]+/g,"");return e!==r&&l.$setViewValue(r),r}}),r.value2mask=function(e){l.$setViewValue(e)})},controller:["$scope",function(e){e.pxForm2mask=function(r){e.value2mask(r)}}]}}]).directive("pxBrCepMask",["$compile",function(e){return{priority:100,restrict:"A",scope:{cleanValue:"@cleanValue"},require:"?ngModel",link:function(r,n,t,l){l&&(angular.isDefined(t.uiMask)||(t.$set("uiMask","99999-999"),e(n)(r)),l.$parsers.push(function(e){if(angular.isDefined(e)){var r=String(e).replace(/[^0-9]+/g,"");return e!==r&&l.$setViewValue(r),r}}),r.value2mask=function(e){l.$setViewValue(e)})},controller:["$scope",function(e){e.pxForm2mask=function(r){e.value2mask(r)}}]}}]).directive("pxBrPhoneMask",["$compile","$timeout",function(e,r){return{priority:100,restrict:"A",scope:{cleanValue:"@cleanValue",validPhone8:"@validPhone8",validPhone9:"@validPhone9",ddd:"=pxDdd"},bindToController:!1,require:"?ngModel",link:function(r,n,t,l){if(l){var a=11;r.ddd===!1&&(a=9),angular.isDefined(t.uiMask)||(r.ddd!==!1?(t.$set("uiMask","(99) 9999-9999?9"),e(n)(r)):(t.$set("uiMask","9999-9999?9"),e(n)(r))),r.tempValue=r.tempValue||"",n.bind("focusout",function(e){angular.isDefined(r.cleanValue)&&(r.cleanValue.length<a||!angular.isDefined(r.validPhone8))&&(r.ddd!==!1?t.$set("uiMask","(99) 9999-9999"):t.$set("uiMask","9999-9999"),l.$setViewValue(r.cleanValue),r.validPhone9=!1,r.validPhone8=!0)}),n.bind("focusin",function(e){angular.isDefined(r.cleanValue)&&r.cleanValue.length<a&&(r.ddd!==!1?t.$set("uiMask","(99) 9999-9999?9"):t.$set("uiMask","9999-9999?9"),l.$setViewValue(r.cleanValue),r.validPhone9=!1,r.validPhone8=!1)}),n.bind("keyup",function(e){"undefined"!=typeof r.cleanValue&&(angular.isDefined(r.cleanValue)?r.cleanValue.length===a&&r.validPhone9===!1||!angular.isDefined(r.validPhone9)?(r.ddd!==!1?t.$set("uiMask","(99) ?99999-9999"):t.$set("uiMask","?99999-9999"),l.$setViewValue(r.cleanValue),r.validPhone9=!0,r.validPhone8=!1):(r.cleanValue.length===a-1&&r.validPhone8===!1||!angular.isDefined(r.validPhone8))&&(r.ddd!==!1?t.$set("uiMask","(99) 9999-9999?9"):t.$set("uiMask","9999-9999?9"),l.$setViewValue(r.cleanValue),r.validPhone9=!1,r.validPhone8=!0):(r.cleanValue=r.tempValue,r.cleanValue.length===a&&r.validPhone9===!1||!angular.isDefined(r.validPhone9)?(r.ddd!==!1?t.$set("uiMask","(99) ?99999-9999"):t.$set("uiMask","?99999-9999"),r.validPhone9=!0,r.validPhone8=!1):(r.cleanValue.length===a-1&&r.validPhone8===!1||!angular.isDefined(r.validPhone8))&&(r.ddd!==!1?t.$set("uiMask","(99) 9999-9999?9"):t.$set("uiMask","9999-9999?9"),r.validPhone9=!1,r.validPhone8=!0)))}),l.$parsers.push(function(e){if(angular.isDefined(e)){var n=String(e).replace(/[^0-9]+/g,"");return r.cleanValue=n,e!==n&&l.$setViewValue(n),n}}),r.value2mask=function(e){l.$setViewValue(r.cleanValue)}}},controller:["$scope",function(e){e.pxForm2mask=function(r){e.value2mask(r)}}]}}]).directive("pxNumberMask",["$filter","$locale",function(e,r){return{restrict:"A",scope:{cleanValue:"@cleanValue",currency:"=pxCurrency",currencySymbol:"@pxCurrencySymbol",numberSuffix:"@pxNumberSuffix",decimalSeparator:"@pxDecimalSeparator",thousandsSeparator:"@pxThousandsSeparator",numberPrecision:"@pxNumberPrecision",useNegative:"=pxUseNegative",usePositiveSymbol:"=pxUsePositiveSymbol"},require:"?ngModel",link:function(e,n,t,l){function a(e){for(var r="",n=0;n<e.length;n++){var t=e.charAt(n);0===r.length&&"0"===t&&(t=!1),t&&t.match(s)&&(v?r.length<v&&(r+=t):r+=t)}return r}function i(e){if(""===e)return e;for(;e.length<m+1;)e="0"+e;return e}function o(e){if(""===e)return C=!0,e;if(e===c+r.NUMBER_FORMATS.DECIMAL_SEP)return"0";var n=i(a(e)),t="",l=0;0===m&&(p="",o="");var o=n.substr(n.length-m,m),s=n.substr(0,n.length-m);if(n=0===m?s:s+p+o,f||""!==$.trim(f)){for(var u=s.length;u>0;u--){var v=s.substr(u-1,1);l++,l%3===0&&(v=f+v),t=v+t}t.substr(0,1)===f&&(t=t.substring(1,t.length)),n=0===m?t:t+p+o}return!h||0===s&&0===o||(n=-1!==e.indexOf("-")&&e.indexOf("+")<e.indexOf("-")?"-"+n:g?"+"+n:""+n),c&&(n=c+n),d&&(n+=d),n}if(n.css({zIndex:0}),l){var s=/[0-9]/,u=e.pxCurrency||!1,c=e.currencySymbol||"",d=e.numberSuffix||"",p=e.decimalSeparator||r.NUMBER_FORMATS.DECIMAL_SEP,f=e.thousandsSeparator||r.NUMBER_FORMATS.GROUP_SEP,m=Number(e.numberPrecision)||2,h=e.useNegative||!1,g=e.usePositiveSymbol||!1;u&&""===c&&(c=r.NUMBER_FORMATS.CURRENCY_SYM);var v=!1,C=!0;l.$parsers.push(function(e){var r="";return"0"===e||""===e&&C!==!1?"0"===e.trim()&&C===!0?0:(C=!0,""):(r=o(e),e!==r&&(l.$setViewValue(r),l.$render()),isNaN(numeral().unformat(r))?0:numeral().unformat(r))})}}}}]).directive("pxGroupShow",["$rootScope","$timeout",function(e,r){return{restrict:"A",require:"?ngModel",link:function(n,t,l,a){1!==e.globals.currentUser.per_developer&&t.hide(),r(function(){var e=angular.element($("#"+l.pxGroupShow).get(0)),r=e.data("$ngModelController");r&&r.$setValidity("required",!0)},0)}}}]).directive("pxGroup",["pxConfig","$rootScope","$mdDialog",function(e,r,n){return{restrict:"E",scope:{id:"@id",required:"=required",control:"=pxControl",placeholder:"@placeholder",inputClass:"@pxInputClass",selectedItem:"=pxSelectedItem",searchClick:"&pxSearchClick",templateUrl:"@pxTemplateUrl","for":"@for",change:"&pxChange"},templateUrl:e.PX_PACKAGE+"system/directives/px-form-item/px-group.html",link:function(t,l,a,i){function o(e,r){e.callback=function(n){e.setValue(n.itemClick),r.hide(),e.searchClick({event:n})},e.setValue=function(r){e.groupSearchControl.setValue(r)},e.setDefault=function(r){e.groupSearchControl.setDefault(r)}}1!==r.globals.currentUser.per_developer&&(l.hide(),1===l.parent().children().length&&l.parent().hide()),""===e.GROUP_ITEM&&""===e.GROUP_LABEL?t.groupSearchConfig={table:e.GROUP_TABLE,fields:[{title:"",labelField:!0,field:e.GROUP_TABLE+"_"+e.GROUP_LABEL_SUFFIX,search:!0,type:"string",filterOperator:"%LIKE%"},{title:"",field:e.GROUP_TABLE+"_"+e.GROUP_ITEM_SUFFIX}]}:t.groupSearchConfig={table:e.GROUP_TABLE,fields:[{title:"",labelField:!0,field:e.GROUP_LABEL,search:!0,type:"string",filterOperator:"%LIKE%"},{title:"",field:e.GROUP_ITEM}]},t.internalControl=t.control||{},t.internalControl.setValue=function(e){t.groupSearchControl.setValue(e)},t.internalControl.setDefault=function(e){t.groupSearchControl.setDefault(e)},t.groupSearchControl={},t.groupSearchClick=function(e){t.templateUrl&&""!==t.templateUrl?n.show({scope:t,preserveScope:!0,controller:o,templateUrl:t.templateUrl,parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0}):t.searchClick({event:e})},t.groupSearchChange=function(e){t.internalControl.selectedItem=t.groupSearchControl.selectedItem,t.change({event:e})},o.$inject=["$scope","$mdDialog"]}}}]).directive("pxInputSearch",["pxConfig","pxUtil","pxArrayUtil","$parse","$http","$sce","$timeout","$mdDialog","$compile",function(e,r,n,t,l,a,i,o,s){return{restrict:"E",scope:{debug:"=pxDebug",id:"@id",config:"@pxConfig",required:"=required",control:"=pxControl",placeholder:"@placeholder",inputClass:"@pxInputClass",complete:"=pxComplete",table:"@pxTable",fields:"@pxFields",orderBy:"@pxOrderBy",recordCount:"@pxRecordCount",where:"@pxWhere",selectedItem:"@pxSelectedItem",url:"@pxUrl",responseQuery:"@pxResponseQuery",localQuery:"@pxLocalQuery",searchFields:"@searchfields",dialog:"=pxDialog",searchClick:"&pxSearchClick",change:"&pxChange",dependencies:"@pxDependencies"},require:"?ngModel",templateUrl:e.PX_PACKAGE+"system/directives/px-form-item/px-input-search.html",link:function(t,a,o,s){if(s){t.inputClass=t.inputClass||"form-control",t.dialog?t.inputGroup="input-group":t.inputGroup="",t.lastSearchTerm=null,t.currentIndex=null,t.justChanged=!1,t.searchTimer=null,t.hideTimer=null,t.searching=!1,t.pause=400,t.minLength=3,t.searchStr=null,t.internalControl=t.control||{},t.internalControl.working=!1,t.internalControl.selectedItem=null,t.internalControl.setValue=function(e){t.setValue(e)},t.internalControl.setDefault=function(e){t.setDefault(e)},t.internalControl.getValue=function(){return{selectedItem:t.selectedItem}},i(function(){var e=angular.element($("#"+t.id+"_inputSearch").get(0));e.on("blur",function(e){t.setValidity()});try{var n=JSON.parse(t.config);if(t.table=t.table||n.table,t.fields=t.fields||n.fields,t.orderBy=t.orderBy||n.orderBy,t.recordCount=t.recordCount||n.recordCount,t.where=t.where||n.where,t.dependencies=[],Array.isArray(t.where))for(var l=0;l<t.where.length;l++)t.where[l].required===!0&&t.dependencies.push(t.where[l])}catch(a){console.error("px-form-item: configuração do campo "+t.id+" inválida")}if(t.dependencies)for(var i=0;i<t.dependencies.length;i++){var o=r.getFieldValueObject(t.dependencies[i]);o.element.on("blur",function(e){var n=r.getFieldValueObject({filter:$(this).attr("id")}),l=angular.element($("#"+$(this).attr("id")).get(0));(null===n.value||""===n.value||n.value!==l.scope().oldValue)&&t.clear(),l.scope().oldValue=angular.copy(n.value)})}},0),t.setValidity=function(){var e=angular.element($("#"+t.id+"_inputSearch").get(0)),r=angular.element($("#"+t.id+"_spanInputSearch").get(0));if(angular.isDefined(t.selectedItem)&&null!==t.selectedItem){var l="";angular.isDefined(t.selectedItem)&&(t.labelField=t.fields[n.getIndexByProperty(t.fields,"labelField",!0)].field,l=t.selectedItem[t.labelField],angular.isDefined(l)||(l=t.selectedItem[t.labelField.toUpperCase()])),t.searchStr!==l?(t.clear(),s.$setValidity("requiredsearch",!1)):(s.$setValidity("requiredsearch",!0),s.$setValidity("required",!0))}else s.$setValidity("requiredsearch",!1),t.clear();i(function(){e.trigger("keyup")},0),o.required===!0&&(s.$invalid?(e.css({borderColor:"#A94442"}),r.css({borderColor:"#A94442"})):(e.css({borderColor:"#CCCCCC"}),r.css({borderColor:"#CCCCCC"})))};var u=function(e,r){return e.length>=t.minLength&&e!==r};if(t.complete===!0){t.processResults=function(e,r,n){if(e&&e.length>0){t.results=[];for(var l=0;l<e.length;l++){for(var a="",i="",o=0;o<n.length;o++){var s="";n[o].labelField&&(s=e[l][n[o].field],angular.isDefined(s)||(s=e[l][n[o].field.toUpperCase()]),a+=n[o].title+s+""),n[o].descriptionField&&(s=e[l][n[o].field],angular.isDefined(s)||(s=e[l][n[o].field.toUpperCase()]),i+=n[o].title+s+" ")}var u={title:a,description:i,item:e[l]};t.results[t.results.length]=u}}else t.results=[]},t.searchTimerComplete=function(n){var a=t.fields;if(n.length>=t.minLength)if(t.localQuery)console.warn("px-complete:","função localQuery não implementada!"),t.searching=!1,t.processResults(JSON.parse(t.localQuery),n);else{angular.forEach(a,function(e){e.search&&(e.filterObject={},e.filterObject={field:e.field,value:r.filterOperator(n,e.filterOperator)})});var i={};i.dsn=e.PROJECT_DSN,i.table=t.table,i.table=t.table,i.fields=angular.toJson(a),i.orderBy=t.orderBy,t.where=r.setFilterObject(t.where,!1,t.table),i.where=angular.toJson(t.where),angular.isDefined(t.recordCount)&&""!==t.recordCount||(t.recordCount=4),i.rows=t.recordCount,angular.isDefined(t.url)&&""!==t.url||(t.url=e.PX_PACKAGE+"system/directives/px-form-item/px-form-item.cfc?method=getData"),l({method:"POST",url:t.url,dataType:"json",params:i}).success(function(e,r,l,i){t.debug&&console.info("px-input-search getData success",e),angular.isDefined(t.responseQuery)&&""!==t.responseQuery||(t.responseQuery="qQuery"),t.searching=!1,t.processResults(t.responseQuery?e[t.responseQuery]:e,n,a)}).error(function(e,r,n,t){alert("Ops! Ocorreu um erro inesperado.\nPor favor contate o administrador do sistema!")})}},t.hideResults=function(){t.hideTimer=i(function(){t.showDropdown=!1},t.pause)},t.resetHideResults=function(){t.hideTimer&&i.cancel(t.hideTimer)},t.hoverRow=function(e){t.currentIndex=e},t.keyPressed=function(e){38!==e.which&&40!==e.which&&13!==e.which?t.searchStr&&""!==t.searchStr?u(t.searchStr,t.lastSearchTerm)?(t.lastSearchTerm=t.searchStr,t.showDropdown=!0,t.currentIndex=-1,t.results=[],t.searchTimer&&i.cancel(t.searchTimer),t.searching=!0,t.searchTimer=i(function(){t.searchTimerComplete(t.searchStr)},t.pause)):t.hasDependencies():(t.showDropdown=!1,t.lastSearchTerm=null):e.preventDefault()},t.selectResult=function(e){t.searchStr=t.lastSearchTerm=e.title,t.internalControl.selectedItem=t.selectedItem=e.item,t.showDropdown=!1,t.results=[],t.setValidity();var r={result:e};t.change({event:r})};var c=a.find("input");c.on("keyup",t.keyPressed),a.on("keyup",function(e){40===e.which?(t.results&&t.currentIndex+1<t.results.length&&(t.currentIndex++,t.$apply(),e.preventDefault(),e.stopPropagation()),t.$apply()):38===e.which?t.currentIndex>=1&&(t.currentIndex--,t.$apply(),e.preventDefault(),e.stopPropagation()):13===e.which?t.results&&t.currentIndex>=0&&t.currentIndex<t.results.length?(t.selectResult(t.results[t.currentIndex]),t.$apply(),e.preventDefault(),e.stopPropagation()):(t.results=[],t.$apply(),e.preventDefault(),e.stopPropagation()):27===e.which?(t.results=[],t.showDropdown=!1,t.$apply()):8===e.which&&(t.selectedItem=null,t.$apply())}),t.showDialog=function(e){t.hasDependencies()||(t.clear(),t.searchClick({event:e}))},t.hasDependencies=function(){if(t.dependencies)for(var e=0;e<t.dependencies.length;e++){var n=r.getFieldValueObject(t.dependencies[e]);if(null===n.value||""===n.value)return n.element.trigger("blur"),alert(t.dependencies[e].message),s.$setValidity("deps",!1),t.setValidity(),!0}return s.$setValidity("deps",!0),!1},i(function(){angular.isDefined(t["default"])&&!angular.isDefined(t.selectedItem)&&t.setValue(t["default"])},0)}}},controller:["$scope","$timeout",function(e,r){e.setDefault=function(t){e["default"]=t,r(function(){e.oldValue=t[e.fields[n.getIndexByProperty(e.fields,"labelField",!0)].field]},0)},e.setValue=function(r){var t=e.fields,l=t[n.getIndexByProperty(t,"labelField",!0)].field,a=r[l];angular.isDefined(a)||(a=r[l.toUpperCase()]),e.searchStr=e.lastSearchTerm=a,e.internalControl.selectedItem=e.selectedItem=r,e.showDropdown=!1,e.results=[],e.setValidity(),e.change({event:r})},e.clear=function(){e.searchStr=e.lastSearchTerm="",e.selectedItem=null,e.showDropdown=!1,e.results=[],e.internalControl.selectedItem=null}}]}}]);